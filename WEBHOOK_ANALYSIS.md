# Анализ вебхуков Prodamus

## Полученные вебхуки (успешная оплата)

### 1. Success URL (GET) - первый запрос
**Когда:** Пользователь перенаправляется после успешной оплаты
**Формат:** GET запрос с параметрами в URL
**Параметры:**
- `_payform_status=success` ✅
- `_payform_id=37934589` (внутренний ID Prodamus)
- `_payform_order_id=PROD-20251112180945692-314112021-3` ✅ (наш order_id)
- `_payform_sign=574bd04ac4c97cf2906cea5c0fba9765457217bb64eb6f62cce6ae59304aec8f` ✅

**Обработка:** Этот вебхук используется только для редиректа пользователя. Бот не обрабатывает его для выдачи доступа (это делает Result URL).

### 2. Success URL (GET) - второй запрос
**Когда:** Повторный запрос от Telegram Bot (user-agent: TelegramBot)
**Формат:** Аналогичен первому
**Примечание:** Это может быть проверка доступности URL от Telegram или повторный запрос.

### 3. Result URL (POST) - основной вебхук ⭐
**Когда:** Prodamus отправляет уведомление о статусе платежа
**Формат:** POST запрос с form-data
**Параметры:**
- `order_num=PROD-20251112180945692-314112021-3` ✅ (наш order_id) - **ИСПРАВЛЕНО: добавлена поддержка order_num**
- `order_id=37934589` (внутренний ID Prodamus)
- `sum=90.00` ✅
- `currency=rub` ✅
- `customer_email=gosha222222@yandex.ru` ✅
- `payment_status=success` ✅ - **ИСПРАВЛЕНО: добавлена поддержка payment_status**
- `payment_status_description=Успешная оплата` ✅
- `sign` в заголовке: `62041342132f71a4e083ad4f311896cdb590c966a6b7b9e95df7eebf2ded1e2b` ✅ - **ИСПРАВЛЕНО: добавлена поддержка подписи в заголовке**

**Обработка:** Это основной вебхук, который обрабатывает бот для выдачи доступа к курсу.

## Исправления в коде

### ✅ Исправлено:

1. **Поддержка `order_num` параметра:**
   ```python
   order_number = data.get("order_num", "") or data.get("order_id", "") or data.get("order", "")
   ```

2. **Поддержка `payment_status` параметра:**
   ```python
   payment_status = (data.get("payment_status", "") or data.get("status", "")).lower()
   ```

3. **Поддержка подписи в заголовке `sign`:**
   ```python
   if request.method == "POST" and "sign" in request.headers:
       data["signature"] = request.headers.get("sign", "")
   ```

4. **Обновлена функция проверки подписи:**
   - Теперь проверяет как `signature`, так и `sign`
   - Исключает `sign` из расчета подписи

5. **Обновлена функция генерации подписи:**
   - Исключает `sign` и `signature` из расчета

## Проверка статусов

### Успешные статусы:
- `success` ✅
- `paid` ✅
- `successful` ✅

### Неуспешные статусы (ожидаемые):
- `fail`
- `failed`
- `error`
- `canceled`
- `cancelled`
- `rejected`

**Текущая обработка:** Бот обрабатывает только успешные статусы. Для неуспешных возвращает "OK" (чтобы Prodamus знал, что запрос получен), но не выдает доступ.

## Что происходит при успешной оплате:

1. **Result URL получает POST запрос** с `payment_status=success`
2. **Бот проверяет подпись** (если настроена)
3. **Бот извлекает `order_num`** (наш order_id: `PROD-20251112180945692-314112021-3`)
4. **Бот ищет платеж в базе** по `order_id`
5. **Бот проверяет сумму** (должна совпадать)
6. **Бот выдает доступ** к курсу пользователю
7. **Бот отправляет уведомление** админам
8. **Бот удаляет запись** из `pending_payments`

## Что нужно проверить при неуспешной оплате:

1. Какой статус приходит в `payment_status`?
2. Какие параметры приходят в Result URL?
3. Правильно ли бот возвращает "OK" (не выдает доступ, но подтверждает получение)?

## Рекомендации:

1. ✅ Все исправления внесены
2. ✅ Код готов к обработке успешных платежей
3. ⏳ Ожидается тест с неуспешной оплатой для проверки обработки ошибок

