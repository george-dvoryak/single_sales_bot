# Настройка автоматического удаления просроченных подписок

## Как это работает

1. Когда пользователь покупает курс, в базе данных сохраняется время истечения доступа (`expiry` timestamp)
2. Скрипт `remove_expired.py` периодически проверяет базу данных на наличие просроченных подписок
3. Для каждой просроченной подписки:
   - Пользователь удаляется из канала курса (ban/unban)
   - Подписка помечается как обработанная (expiry = 0)
   - Пользователю отправляется уведомление

## Быстрая настройка

### Для macOS/Linux (локально)

1. Откройте терминал и выполните:
   ```bash
   crontab -e
   ```

2. Добавьте строку (замените `/path/to/makeup_courses_bot` на реальный путь):
   ```bash
   */5 * * * * cd /Users/g.dvoryak/Desktop/makeup_courses_bot && /usr/bin/python3 remove_expired.py >> /Users/g.dvoryak/Desktop/makeup_courses_bot/cleanup.log 2>&1
   ```

3. Сохраните файл (в nano: Ctrl+X, затем Y, затем Enter)

4. Проверьте, что задача добавлена:
   ```bash
   crontab -l
   ```

5. Проверьте логи через несколько минут:
   ```bash
   tail -f cleanup.log
   ```

### Для PythonAnywhere

1. Войдите в PythonAnywhere Dashboard
2. Перейдите в раздел **Tasks**
3. Нажмите **Create a new scheduled task**
4. Заполните:
   - **Command**: `python3 /home/<ваш_username>/makeup_courses_bot/remove_expired.py`
   - **Hour**: `*` (каждый час)
   - **Minute**: `*/5` (каждые 5 минут)
5. Сохраните задачу

### Тестирование

После настройки автоматического запуска:

1. **Проверьте, что скрипт запускается**:
   - Подождите 5 минут после настройки cron
   - Проверьте логи: `tail -f cleanup.log` (если настроен) или логи PythonAnywhere

2. **Проверьте через бота**:
   - Отправьте команду `/cleanup_expired` в Telegram боте
   - Вы увидите статистику и результат обработки

3. **Создайте тестовую подписку**:
   - Купите курс с очень коротким временем доступа (например, 1 минута)
   - Подождите 1-2 минуты
   - Проверьте, что пользователь удален из канала

## Устранение проблем

### Скрипт не запускается

1. Проверьте права на выполнение:
   ```bash
   chmod +x remove_expired.py
   ```

2. Проверьте путь к Python:
   ```bash
   which python3
   ```

3. Проверьте логи cron (на Linux):
   ```bash
   grep CRON /var/log/syslog
   ```

### Пользователи не удаляются

1. Проверьте права бота в канале:
   - Бот должен быть администратором
   - Бот должен иметь право банить пользователей

2. Используйте команду `/diag_channels` в боте для диагностики

3. Проверьте логи скрипта на наличие ошибок

### Логи не появляются

Скрипт пишет логи в stderr и stdout. Если вы перенаправляете вывод в файл, убедитесь что используете `2>&1`:
```bash
python3 remove_expired.py >> cleanup.log 2>&1
```

## Рекомендации

- **Частота запуска**: каждые 5 минут - оптимально для точного удаления
- **Мониторинг**: периодически проверяйте логи на наличие ошибок
- **Тестирование**: после настройки создайте тестовую подписку с коротким временем для проверки

